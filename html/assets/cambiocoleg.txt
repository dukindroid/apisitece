///                                                                                                           ///
// Historia de las Consultas SQL en el contexto socioeconómico del México postmoderno, 1era ed., porrúa, 2016  //
///                                                                                                           ///

/*
select * from coleg_carr_por_fecha where carreraid in (select id from carrerasactivas where n_sucursal = 30) order by carreraid desc;
*/

select sucursales.nombre as sucursal, 
        carreras.nombre as carrera,
        count(*) as cantidad
        from coleg_carr_por_fecha
        inner join carreras on 
            (coleg_carr_por_fecha.carreraid = carreras.id )
        inner join sucursales on 
            (coleg_carr_por_fecha.n_sucursal = sucursales.n_sucursal )
        where carreraid in 
            (
            select id 
            from carrerasactivas 
            where n_sucursal in 
                (
                select n_sucursal 
                from sucursales 
                where status = 'A'
                )
            ) 
        order by sucursal desc;

segundo intento

select sucursales.nombre as sucursal, 
        carreras.nombre as carrera,
        count(*) as cantidad
        from coleg_carr_por_fecha
        inner join carreras on 
            (coleg_carr_por_fecha.carreraid = carreras.id )
        inner join sucursales on 
            (coleg_carr_por_fecha.n_sucursal = sucursales.n_sucursal )
        where carreraid in ()
            select id 
            from carrerasactivas 
            where n_sucursal in 
                (
                select n_sucursal 
                from sucursales 
                where status = 'A'
                )
            order by n_sucursal desc
        	)


		/* 0.1276 seg
SELECT car.id 
FROM carreras as car
inner join sucursales as suc 
on (car.zona = suc.N_Sucursal)
where car.status = 'A' 
and suc.status = 'A'
and car.zona <> '1' 
order by car.zona
		*/
	
		/* 0.0028 seg
SELECT car.id, car.nombre, 
FROM carreras as car
inner join sucursales as suc 
on (car.zona = suc.N_Sucursal)
where car.status = 'A' 
and suc.status = 'A'
and car.zona <> '1' 
order by car.zona
		*/
	
/*     0.0007 PUTOS DE LA VERGAS SEGUNDOSSS°!!°°!° contra .1276 segundos??°!?°!? no mamar....
 *     una pequeña mejora del 18,228%

	select id from carreras activas
 */
		/*
		select CAR.nombre as Carrera,
		EXP.colegiatura as UltimoPrecio,
		EXP.fecha_registro
		from exp_alumnos as EXP
		inner join cursos as CUR on (EXP.curso = CUR.id) 
		inner join carreras as CAR on (CAR.id = CUR.Carrera)
		where CUR.carrera in
		*/
/*

Va de nuevo por si no me creen
*/

 Mostrando filas 0 - 24 (total de 133, La consulta tardó 0.0028 seg) [nombre: TECNICO EN GASTRONOMíA INTERNACIONAL VESPERTINO - LICENCIATURA EN COMERCIO EXTERIOR Y ADMINISTRAIóN]
SELECT car.id, car.nombre FROM carreras as car inner join sucursales as suc on (car.zona = suc.N_Sucursal) where car.status = 'A' and suc.status = 'A' and car.zona <> '1' order by car.nombre desc
/*
Creamos la vista....
*/
 MySQL ha devuelto un conjunto de valores vacío (es decir: cero columnas). (La consulta tardó 0.0646 seg)
CREATE VIEW carrerasActivas AS SELECT car.id, car.nombre FROM carreras as car inner join sucursales as suc on (car.zona = suc.N_Sucursal) where car.status = 'A' and suc.status = 'A' and car.zona <> '1' order by car.nombre desc

/*
Y la cargamos completa...
*/

 Mostrando filas 0 - ...  (La consulta tardó 0.0028 seg)
SELECT * FROM `carrerasactivas`
/*
y luego por partes
*/

 Mostrando filas 0 - ...  (La consulta tardó 0.0027 seg)
select id from carrerasActivas

/* entonces con esto creamos la vista que se ocupa : 

*/

MySQL ha devuelto un conjunto de valores vacío (es decir: cero columnas). (La consulta tardó 0.1125 seg)
CREATE VIEW Coleg_Carr_Por_Fecha AS 
	select 
	CAR.nombre as Carrera, 
	EXP.colegiatura as UltimoPrecio, 
	EXP.fecha_registro as Fecha
	CUR.n_sucursal as n_sucursal
	from exp_alumnos as EXP 
	inner join cursos as CUR on (EXP.curso = CUR.id) 
	inner join carreras as CAR on (CAR.id = CUR.Carrera) 
	where CUR.carrera in 
		(select id from carrerasactivas)
	order by Fecha desc;

/* y la cargamos */

 Mostrando filas 0 - ...  (La consulta tardó 0.0625 seg)
select * from Coleg_Carr_Por_Fecha

/* y la contamos, por que no, por si las dudas */
Su consulta se ejecutó con éxito
select count(*) from Coleg_Carr_Por_Fecha

count(*)
55394

/* ni si quiera se ocupa tiempo para contar eso. HELL YEAH! 
 probemos la misma consulta SIN vista:

 */

select count(*) from exp_alumnos as EXP inner join cursos as CUR on (EXP.curso = CUR.id) inner join carreras as CAR on (CAR.id = CUR.Carrera) where CUR.carrera in ( SELECT car.id FROM carreras as car inner join sucursales as suc on (car.zona = suc.N_Sucursal) where car.status = 'A' and suc.status = 'A' and car.zona <> '1' order by car.nombre desc )
count(*)
55394

/* todo bien hasta aquí no?? ahora lo que sigue... encontrar el cambio de colegiatura para cada carrera 
 
este era el query original:
 */

select CAR.nombre as Carrera, 
EXP.colegiatura as UltimoPrecio, 
EXP.fecha_registro 
from exp_alumnos as EXP   
inner join cursos as CUR on (EXP.curso = CUR.id) 
inner join carreras as CAR on (CAR.id = CUR.Carrera) 
where CUR.carrera in (
    SELECT car.id 
    FROM carreras as car 
    inner join sucursales as suc 
    on (car.zona = suc.N_Sucursal) 
    where car.status = 'A' 
    and suc.status = 'A' 
    and car.zona <> '1' 
    order by car.nombre desc
    )


 Mostrando filas 0 - 24 (total de 55394, La consulta tardó 0.0041 seg)
select CAR.nombre as Carrera, EXP.colegiatura as UltimoPrecio, EXP.fecha_registro from exp_alumnos as EXP inner join cursos as CUR on (EXP.curso = CUR.id) inner join carreras as CAR on (CAR.id = CUR.Carrera) where CUR.carrera in ( SELECT car.id FROM carreras as car inner join sucursales as suc on (car.zona = suc.N_Sucursal) where car.status = 'A' and suc.status = 'A' and car.zona <> '1' order by car.nombre desc )

select * 
from coleg_carr_por_fecha 
where carreraid in 
(select id from carrerasactivas where n_sucursal = 30)
order by carreraid desc

/*
    $repoColima = ORM::get_db()->exec(
        'select * 
        from coleg_carr_por_fecha 
        where carreraid in 
            (select id 
            from carrerasactivas 
            where n_sucursal = 30) 
        order by carreraid desc;'
        );
    $repo = new Sitece16\Repositorios\RepoCrudo;
    $CarrerasActivas = $repo->consulta();
    foreach ($CarrerasActivas as $unaCarrera) {
       $arregloDeArreglos[$unaCarrera->id] = $repo->consulta2($unaCarrera->id);
    } 
*/